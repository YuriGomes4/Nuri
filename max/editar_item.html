<!DOCTYPE html>
<html lang="pt-br">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>Nossas histórias</title>
    <link rel="icon" type="image/x-icon" href="/assets/images/max/logo.png">

    <link rel="manifest" href="/assets/pwa/manifest.json">
	  
	<!--<link rel="icon" type="image/x-icon" href="/assets/images/favicon.ico">-->

	<link href='https://fonts.googleapis.com/css?family=Reenie+Beanie|Shantell+Sans|Kavoon' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="/assets/fontawesome/css/all.css">
    
    <link href="/assets/css/max/global.css" rel="stylesheet" type="text/css" />
    <link href="/assets/css/max/editar_item.css" rel="stylesheet" type="text/css" />

    <script src="/assets/js/github_api.js"></script>
    <script src="/assets/js/imgur_api.js"></script>
    <script src="/assets/js/auth.js"></script>
</head>

<body>

    <div id="blackout"></div>

    <div id="fundo"></div>

    <div id="main">
        <div id="editor">
            <div id="editor-header">
                <div id="back-btn" onclick="page_out('back')">
                    <i class="fa-solid fa-arrow-left"></i>
                </div>
                <p>Editar</p>
                <span onclick="remover_item()" style="display: none;">Remover</span>
            </div>
            <div id="editor-body">
                <div id="ed-titulo" class="input-group">
                    <label for="titulo">Título *</label>
                    <input type="text" id="titulo">
                </div>
                <div id="ed-sinopse" class="input-group">
                    <label for="sinopse">Sinopse</label>
                    <textarea id="sinopse"></textarea>
                </div>
                <div id="outras-infos">
                    <div id="textos">
                        <div id="ed-autor" class="input-group">
                            <label for="autor">Autor</label>
                            <input type="text" id="autor">
                        </div>
                        <div id="ed-data" class="input-group">
                            <label for="data">Data *</label>
                            <input type="date" id="data">
                        </div>
                        <div id="ed-exclusivo">
                            <label>Exclusivo?</label>
                            <input type="checkbox" id="exclusivo">
                        </div>
                    </div>
                    <div id="imagem-capa-upload" class="input-group">
                        <label for="imagem-capa">Capa</label>
                        <div id="imagem-capa-preview">
                            <input type="file" id="imagem-capa" style="display: none;" onchange="previewImageCapa(event)">
                            <img id="preview-capa" src="" alt="Preview" style="opacity: 0;" onclick="document.getElementById('imagem-capa').click()">
                            <div id="btn-remover" style="display: none;" onclick="remover_imagem_capa()">
                                <p>Remover</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="ed-participantes" class="input-group">
                    <label for="participantes">Quem participa</label>
                    <div id="div-ed-participantes" class="input-group">
                        <input type="text" id="participantes"></input>
                        <i id="btn-add-participante" class="fa-solid fa-plus" onclick="adicionar_participante()"></i>
                    </div>
                    <div id="participantes-list">
                    </div>
                </div>
                <div id="partes">
                    <div id="partes-header">
                        <p>Partes</p>
                    </div>
                    <div id="partes-body">
                        <div class="parte" parte-local-id="0">
                            <div class="parte-header">
                                <p>1° Parte</p>
                                <div class="parte-btns-ordem">
                                    <i class="fa-solid fa-chevron-up"></i>
                                    <i class="fa-solid fa-chevron-down"></i>
                                </div>
                                <i class="fa-solid fa-trash"></i>
                            </div>
                            <div class="parte-body">
                                <div class="pt-body-main">
                                    <div class="pbm-infos">
                                        <div class="input-group">
                                            <label for="pt-titulo-0">Título</label>
                                            <input type="text" id="pt-titulo-0" class="pt-titulo">
                                        </div>
                                        <div class="div-pt-exclusivo">
                                            <label>Exclusivo?</label>
                                            <input type="checkbox" id="pt-exclusivo-0" class="pt-exclusivo">
                                        </div>
                                    </div>
                                    <div class="parte-imagem-upload">
                                        <input type="file" id="pt-imagem-0" class="pt-imagem" style="display: none;" onchange="previewImageParte(event)">
                                        <img id="pt-preview-imagem-0" class="pt-preview-imagem" src="" alt="Preview" style="opacity: 0;" onclick="document.getElementById('pt-imagem-0').click()">
                                        <div id="pt-btn-remover-imagem-0" class="pt-btn-remover-imagem" style="display: none;" onclick="remover_imagem_parte(event)">
                                            <p>Remover</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label for="pt-descricao-0">Descrição</label>
                                    <textarea id="pt-descricao-0"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="partes-footer">
                        <div id="btn-add-parte" onclick="addParte()">
                            <i class="fa-solid fa-plus"></i>
                            <p>Adicionar parte</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="btn-salvar" onclick="salvar()">
        <i class="fa-solid fa-save"></i>
    </div>

    <script>

        const urlParams = new URLSearchParams(window.location.search);
        var tipo = urlParams.get('tipo');
        var item_id = urlParams.get('id');
        var item = {};
        var dict_imagens = {};
        var imagens_local = {};
        var tipo_editor = 'editar';

        if (tipo && item_id) {
            tipo_editor = 'editar';
        } else {
            tipo_editor = 'criar';
            tipo = 'historia';
            item_id = Math.floor(100000 + Math.random() * 900000).toString();
        }

        console.log(window.location.href);

        //var titulo_item = document.getElementById('editor-header').querySelector('p');
        //titulo_item.innerText = `Editar ${tipo} - ${item_id}`;

        if (tipo_editor === 'editar') {
            var btn_remover = document.getElementById('editor-header').querySelector('span');
            btn_remover.style.display = 'block';
            btn_remover.textContent = `Remover ${tipo}`;
        }

        function setCookie(name, value) {
			document.cookie = name + "=" + value;
		}

        function getCookie(name) {
			const cookieValue = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
			return cookieValue ? cookieValue.pop() : '';
		}

        var api_headers = {};

        async function verify_token_header() {
            if (!document.cookie.split('; ').find(row => row.startsWith('gk='))) {
            setCookie("gk", "");
            } else {
            try {
                console.log(getCookie("gk").split('$sep$')[0])
                var response = await fetch(`https://api.github.com/user`, {
                headers: {
                    Authorization: `token ${getCookie("gk").split('$sep$')[0]}`
                }
                });

                if (response.ok) {
                console.log('Usuário autenticado:', response);
                const token = getCookie("gk").split('$sep$')[0];
                api_headers = {
                    Authorization: `Bearer ${token}`
                };

                } else {
                console.error('Erro ao autenticar usuário:', response.statusText);
                }
            } catch (error) {
                console.error('Erro ao autenticar usuário:', error);
            }
            }
        }

        (async () => {
            await verify_token_header();
        })();

        function previewImageCapa(event) {

            var file = event.target.files[0];
            var fileExtension = file.name.split('.').pop();
            var randomDigits = Math.floor(100000 + Math.random() * 900000);
            var newFileName = `imagem_${randomDigits}.${fileExtension}`;

            var reader = new FileReader();
            reader.onload = function() {
                var output = document.getElementById('preview-capa');
                output.src = reader.result;
                output.setAttribute('file-name', newFileName);
                output.style.opacity = 1;

                var btn = document.getElementById('btn-remover');
                btn.style.display = 'flex';

                //dict_imagens[newFileName] = reader.result.split(',')[1];
                dict_imagens[newFileName] = file;
                imagens_local[newFileName] = 'capa';
            }
            reader.readAsDataURL(event.target.files[0]);
        }

        function remover_imagem_capa() {
            var input = document.getElementById('imagem-capa');
            var preview = document.getElementById('preview-capa');
            var btn = document.getElementById('btn-remover');

            delete dict_imagens[preview.getAttribute('file-name')];
            delete imagens_local[preview.getAttribute('file-name')];

            input.value = '';
            preview.src = '';
            preview.style.opacity = 0;
            btn.style.display = 'none';
        }

        function previewImageParte(event) {

            var parte_id = event.target.id.split('-')[2];

            var file = event.target.files[0];
            var fileExtension = file.name.split('.').pop();
            var randomDigits = Math.floor(100000 + Math.random() * 900000);
            if (file.type.startsWith('video/')) {
                var newFileName = `video_${randomDigits}.${fileExtension}`;
            } else {
                var newFileName = `imagem_${randomDigits}.${fileExtension}`;
            }

            var reader = new FileReader();
            reader.onload = function() {
                var output;
                if (file.type.startsWith('video/')) {
                    output = document.createElement('video');
                    //output.setAttribute('controls', 'controls');
                } else {
                    output = document.createElement('img');
                }
                output.id = 'pt-preview-imagem-' + parte_id;
                output.classList.add('pt-preview-imagem');
                output.onclick = function() {
                    document.getElementById('pt-imagem-' + parte_id).click();
                };
                output.src = reader.result;
                output.setAttribute('file-name', newFileName);
                output.style.opacity = 1;

                var previewContainer = document.getElementById('pt-preview-imagem-' + parte_id).parentNode;
                previewContainer.replaceChild(output, document.getElementById('pt-preview-imagem-' + parte_id));

                var btn = document.getElementById('pt-btn-remover-imagem-' + parte_id);
                btn.style.display = 'flex';

                //dict_imagens[newFileName] = reader.result.split(',')[1];
                dict_imagens[newFileName] = file;
                imagens_local[newFileName] = parte_id;
            }
            reader.readAsDataURL(event.target.files[0]);

            if (event.target.files.length > 1) {
                (async () => {
                    for (var i = 1; i < event.target.files.length; i++) {
                        addParte();

                        var new_parte_id = document.getElementsByClassName('parte').length - 1;

                        var file = event.target.files[i];
                        var fileExtension = file.name.split('.').pop();
                        var randomDigits = Math.floor(100000 + Math.random() * 900000);
                        if (file.type.startsWith('video/')) {
                            var newFileName = `video_${randomDigits}.${fileExtension}`;
                        } else {
                            var newFileName = `imagem_${randomDigits}.${fileExtension}`;
                        }

                        await new Promise((resolve) => {
                            var reader = new FileReader();
                            reader.onload = function() {
                                var output;
                                if (file.type.startsWith('video/')) {
                                    output = document.createElement('video');
                                    //output.setAttribute('controls', 'controls');
                                } else {
                                    output = document.createElement('img');
                                }
                                output.id = 'pt-preview-imagem-' + new_parte_id;
                                output.classList.add('pt-preview-imagem');
                                output.onclick = function() {
                                    document.getElementById('pt-imagem-' + new_parte_id).click();
                                };
                                output.src = reader.result;
                                output.setAttribute('file-name', newFileName);
                                output.style.opacity = 1;

                                var previewContainer = document.getElementById('pt-preview-imagem-' + new_parte_id).parentNode;
                                previewContainer.replaceChild(output, document.getElementById('pt-preview-imagem-' + new_parte_id));

                                var btn = document.getElementById('pt-btn-remover-imagem-' + new_parte_id);
                                btn.style.display = 'flex';

                                //dict_imagens[newFileName] = reader.result.split(',')[1];
                                dict_imagens[newFileName] = file;
                                imagens_local[newFileName] = new_parte_id;

                                if (i === event.target.files.length - 1) {
                                    window.scrollTo(0, document.body.scrollHeight);
                                }

                                resolve();
                            }
                            reader.readAsDataURL(event.target.files[i]);
                        });
                    }
                })();
            }
        }

        function remover_imagem_parte(event) {
            var parte_id = event.target.id.split('-')[4];
            var input = document.getElementById('pt-imagem-' + parte_id);
            var preview = document.getElementById('pt-preview-imagem-' + parte_id);
            var btn = document.getElementById('pt-btn-remover-imagem-' + parte_id);

            delete dict_imagens[preview.getAttribute('file-name')];
            delete imagens_local[preview.getAttribute('file-name')];

            input.value = '';
            preview.src = '';
            preview.style.opacity = 0;
            btn.style.display = 'none';
        }

        function adicionar_participante() {
            var participante = document.getElementById('participantes').value;
            if (participante) {
                var participantes_list = document.getElementById('participantes-list');
                var participante_div = document.createElement('div');
                participante_div.classList.add('participante');
                participante_div.addEventListener('click', function(event) {
                    event.target.remove();
                });

                var participante_p = document.createElement('p');
                participante_p.innerText = participante;

                var participante_i = document.createElement('i');
                participante_i.classList.add('fa-solid', 'fa-x');

                participante_div.appendChild(participante_p);
                participante_div.appendChild(participante_i);

                participantes_list.appendChild(participante_div);

                document.getElementById('participantes').value = '';
            }
        }

        function carregar_item () {
            if (tipo && item_id) {
                console.log(`Tipo: ${tipo}, ID: ${item_id}`);
                /*fetch(`https://api.github.com/repos/YuriGomes4/Nuri/contents/assets/conteudo/${tipo}/${item_id}/main.json?timestamp=${new Date().getTime()}`, {headers: api_headers})
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok ' + response.statusText);
                        }
                        return response.json();
                    })
                    .catch(error => {
                        console.error('There has been a problem with your fetch operation:', error);

                        fetch(`https://raw.githubusercontent.com/YuriGomes4/Nuri/main/assets/conteudo/${tipo}/${item_id}/main.json?timestamp=${new Date().getTime()}`)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Network response was not ok ' + response.statusText);
                                }
                                return response.json();
                            })
                            .catch(error => {
                                console.error('There has been a problem with your fetch operation:', error);
                            })
                            .then(item_json => {
                                //main_json = JSON.parse(decodeURIComponent(escape(atob(item_json.content))));
                                
                                carregar_dados(item_json);
                            });
                    })
                    .then(item_json => {
                        //main_json = JSON.parse(decodeURIComponent(escape(atob(item_json.content))));
                        
                        carregar_dados(JSON.parse(decodeURIComponent(escape(atob(item_json.content)))));
                    });*/

                carregar_dados(JSON.parse(sessionStorage.getItem(tipo))[item_id]);
            } else {
                console.log('Parâmetros tipo e id não encontrados.');
            }
        }

        if (tipo_editor === 'editar') {
            carregar_item();
        } else {
            var partes_body = document.getElementById('partes-body');
            partes_body.innerHTML = '';
            addParte();
        }

        function carregar_dados(item_json) {
            item = item_json;
            console.log(item);

            document.getElementById('titulo').value = item.nome;
            document.getElementById('sinopse').value = item.sinopse;
            document.getElementById('autor').value = item.autor || '';
            document.getElementById('data').value = item.data;
            document.getElementById('exclusivo').checked = item.exclusivo;

            var imagem_capa = '';
            if (item.capa !== '') {
                if (item.capa.includes('imgur')) {
                    imagem_capa = item.capa;
                } else {
                    imagem_capa = `https://raw.githubusercontent.com/YuriGomes4/Nuri/main/assets/conteudo/${tipo}/${item_id}/fotos/` + item.capa;
                }
                document.getElementById('preview-capa').src = imagem_capa;
                document.getElementById('preview-capa').style.opacity = 1;
                document.getElementById('btn-remover').style.display = 'flex';
            }

            if ("participantes" in item) {
                var participantes_list = document.getElementById('participantes-list');
                item.participantes.forEach(participante => {
                    var participante_div = document.createElement('div');
                    participante_div.classList.add('participante');
                    participante_div.addEventListener('click', function(event) {
                        event.target.remove();
                    });

                    var participante_p = document.createElement('p');
                    participante_p.innerText = participante;

                    var participante_i = document.createElement('i');
                    participante_i.classList.add('fa-solid', 'fa-x');

                    participante_div.appendChild(participante_p);
                    participante_div.appendChild(participante_i);

                    participantes_list.appendChild(participante_div);
                });
            }

            var partes_body = document.getElementById('partes-body');

            partes_body.innerHTML = '';

            item.partes.forEach((parte, index) => {
                var parte_div = document.createElement('div');
                parte_div.classList.add('parte');
                parte_div.setAttribute('parte-local-id', index);

                var parte_header = document.createElement('div');
                parte_header.classList.add('parte-header');

                var parte_header_p = document.createElement('p');
                parte_header_p.innerText = `${index + 1}° Parte`;

                var parte_header_btns_ordem = document.createElement('div');
                parte_header_btns_ordem.classList.add('parte-btns-ordem');
                
                var parte_header_btns_ordem_up = document.createElement('i');
                parte_header_btns_ordem_up.classList.add('fa-solid', 'fa-chevron-up');
                parte_header_btns_ordem_up.addEventListener('click', subirOrdemItem);

                var parte_header_btns_ordem_down = document.createElement('i');
                parte_header_btns_ordem_down.classList.add('fa-solid', 'fa-chevron-down');
                parte_header_btns_ordem_down.addEventListener('click', descerOrdemItem);
                parte_header_btns_ordem_down.style.display = 'none';

                parte_header_btns_ordem.appendChild(parte_header_btns_ordem_up);
                parte_header_btns_ordem.appendChild(parte_header_btns_ordem_down);

                var parte_header_i = document.createElement('i');
                parte_header_i.classList.add('fa-solid', 'fa-trash');
                parte_header_i.addEventListener('click', remParte);

                parte_header.appendChild(parte_header_p);
                parte_header.appendChild(parte_header_btns_ordem);
                parte_header.appendChild(parte_header_i);

                var parte_body = document.createElement('div');
                parte_body.classList.add('parte-body');

                var pt_body_main = document.createElement('div');
                pt_body_main.classList.add('pt-body-main');

                var pbm_infos = document.createElement('div');
                pbm_infos.classList.add('pbm-infos');

                var pt_titulo = document.createElement('div');
                pt_titulo.classList.add('input-group');

                var pt_titulo_label = document.createElement('label');
                pt_titulo_label.setAttribute('for', `pt-titulo-${index}`);
                pt_titulo_label.innerText = 'Título';

                var pt_titulo_input = document.createElement('input');
                pt_titulo_input.setAttribute('type', 'text');
                pt_titulo_input.setAttribute('id', `pt-titulo-${index}`);
                pt_titulo_input.classList.add('pt-titulo');
                pt_titulo_input.value = parte.nome;

                pt_titulo.appendChild(pt_titulo_label);
                pt_titulo.appendChild(pt_titulo_input);

                var div_pt_exclusivo = document.createElement('div');
                div_pt_exclusivo.classList.add('div-pt-exclusivo');

                var pt_exclusivo_label = document.createElement('label');
                pt_exclusivo_label.innerText = 'Exclusivo?';

                var pt_exclusivo_input = document.createElement('input');
                pt_exclusivo_input.setAttribute('type', 'checkbox');
                pt_exclusivo_input.setAttribute('id', `pt-exclusivo-${index}`);
                pt_exclusivo_input.classList.add('pt-exclusivo');
                pt_exclusivo_input.checked = parte.exclusivo;

                div_pt_exclusivo.appendChild(pt_exclusivo_label);
                div_pt_exclusivo.appendChild(pt_exclusivo_input);

                pbm_infos.appendChild(pt_titulo);
                pbm_infos.appendChild(div_pt_exclusivo);

                var parte_imagem_upload = document.createElement('div');
                parte_imagem_upload.classList.add('parte-imagem-upload');

                var pt_imagem_input = document.createElement('input');
                pt_imagem_input.setAttribute('type', 'file');
                pt_imagem_input.accept = 'image/*, video/*';
                pt_imagem_input.multiple = true;
                pt_imagem_input.setAttribute('id', `pt-imagem-${index}`);
                pt_imagem_input.classList.add('pt-imagem');
                pt_imagem_input.style.display = 'none';
                pt_imagem_input.addEventListener('change', previewImageParte);

                if (parte.imagem.includes('.mp4')) {
                    var pt_preview_video = document.createElement('video');
                    pt_preview_video.setAttribute('id', `pt-preview-imagem-${index}`);
                    pt_preview_video.classList.add('pt-preview-imagem');
                    if (parte.imagem.includes('imgur')) {
                        pt_preview_video.setAttribute('src', parte.imagem);
                    } else {
                        pt_preview_video.setAttribute('src', `https://raw.githubusercontent.com/YuriGomes4/Nuri/main/assets/conteudo/${tipo}/${item_id}/fotos/` + parte.imagem);
                    }
                    //pt_preview_video.setAttribute('controls', 'controls');
                    pt_preview_video.style.opacity = 1;
                    pt_preview_video.addEventListener('click', function() {
                        document.getElementById(`pt-imagem-${index}`).click();
                    });

                    var pt_btn_remover_imagem = document.createElement('div');
                    pt_btn_remover_imagem.setAttribute('id', `pt-btn-remover-imagem-${index}`);
                    pt_btn_remover_imagem.classList.add('pt-btn-remover-imagem');
                    pt_btn_remover_imagem.style.display = 'flex';
                    pt_btn_remover_imagem.addEventListener('click', remover_imagem_parte);

                    var pt_btn_remover_imagem_p = document.createElement('p');
                    pt_btn_remover_imagem_p.innerText = 'Remover';

                    pt_btn_remover_imagem.appendChild(pt_btn_remover_imagem_p);

                    parte_imagem_upload.appendChild(pt_imagem_input);
                    parte_imagem_upload.appendChild(pt_preview_video);
                    parte_imagem_upload.appendChild(pt_btn_remover_imagem);
                } else {
                    var pt_preview_imagem = document.createElement('img');
                    pt_preview_imagem.setAttribute('id', `pt-preview-imagem-${index}`);
                    pt_preview_imagem.classList.add('pt-preview-imagem');
                    var imagem_parte = '';
                    if (parte.imagem !== '') {
                        //imagem_parte = `/assets/conteudo/${tipo}/${item_id}/fotos/` + parte.imagem;
                        if (parte.imagem.includes('imgur')) {
                            imagem_parte = parte.imagem;
                        } else {
                            imagem_parte = `https://raw.githubusercontent.com/YuriGomes4/Nuri/main/assets/conteudo/${tipo}/${item_id}/fotos/` + parte.imagem;
                        }
                        pt_preview_imagem.setAttribute('src', imagem_parte);
                        pt_preview_imagem.style.opacity = 1;
                    } else {
                        pt_preview_imagem.style.opacity = 0;
                    }
                    pt_preview_imagem.addEventListener('click', function() {
                        document.getElementById(`pt-imagem-${index}`).click();
                    });

                    var pt_btn_remover_imagem = document.createElement('div');
                    pt_btn_remover_imagem.setAttribute('id', `pt-btn-remover-imagem-${index}`);
                    pt_btn_remover_imagem.classList.add('pt-btn-remover-imagem');
                    if (parte.imagem !== '') {
                        pt_btn_remover_imagem.style.display = 'flex';
                    } else {
                        pt_btn_remover_imagem.style.display = 'none';
                    }
                    pt_btn_remover_imagem.addEventListener('click', remover_imagem_parte);

                    var pt_btn_remover_imagem_p = document.createElement('p');
                    pt_btn_remover_imagem_p.innerText = 'Remover';

                    pt_btn_remover_imagem.appendChild(pt_btn_remover_imagem_p);

                    parte_imagem_upload.appendChild(pt_imagem_input);
                    parte_imagem_upload.appendChild(pt_preview_imagem);
                    parte_imagem_upload.appendChild(pt_btn_remover_imagem);
                }

                pt_body_main.appendChild(pbm_infos);
                pt_body_main.appendChild(parte_imagem_upload);

                var pt_descricao = document.createElement('div');
                pt_descricao.classList.add('input-group');

                var pt_descricao_label = document.createElement('label');
                pt_descricao_label.setAttribute('for', `pt-descricao-${index}`);
                pt_descricao_label.innerText = 'Descrição';

                var pt_descricao_textarea = document.createElement('textarea');
                pt_descricao_textarea.setAttribute('id', `pt-descricao-${index}`);
                pt_descricao_textarea.innerText = parte.descricao;

                pt_descricao.appendChild(pt_descricao_label);
                pt_descricao.appendChild(pt_descricao_textarea);

                parte_body.appendChild(pt_body_main);
                parte_body.appendChild(pt_descricao);

                parte_div.appendChild(parte_header);
                parte_div.appendChild(parte_body);

                partes_body.appendChild(parte_div);

                // Adjust textarea height
                pt_descricao_textarea.style.height = "auto";
                pt_descricao_textarea.style.height = (pt_descricao_textarea.scrollHeight) + "px";
                pt_descricao_textarea.addEventListener("input", function() {
                    const scrollPosition = window.scrollY;
                    this.style.height = "auto";
                    this.style.height = (this.scrollHeight) + "px";
                    window.scrollTo(0, scrollPosition);
                });
            });

            // Hide the up button for the first item
            document.querySelectorAll('.parte-btns-ordem .fa-chevron-up').forEach((btn, index) => {
                btn.style.display = index === 0 ? 'none' : 'flex';
            });

            var partes = document.getElementsByClassName('parte');
            // Hide the down button for the last item
            document.querySelectorAll('.parte-btns-ordem .fa-chevron-down').forEach((btn, index) => {
                btn.style.display = index === partes.length - 1 ? 'none' : 'flex';
            });
        }

        function addParte() {
            var partes_body = document.getElementById('partes-body');
            var partes = document.getElementsByClassName('parte');
            var parte_local_id = partes.length;

            var parte_div = document.createElement('div');
            parte_div.classList.add('parte');
            parte_div.setAttribute('parte-local-id', parte_local_id);

            var parte_header = document.createElement('div');
            parte_header.classList.add('parte-header');

            var parte_header_p = document.createElement('p');
            parte_header_p.innerText = `${parte_local_id + 1}° Parte`;

            var parte_header_btns_ordem = document.createElement('div');
            parte_header_btns_ordem.classList.add('parte-btns-ordem');

            var parte_header_btns_ordem_up = document.createElement('i');
            parte_header_btns_ordem_up.classList.add('fa-solid', 'fa-chevron-up');
            parte_header_btns_ordem_up.addEventListener('click', subirOrdemItem);

            var parte_header_btns_ordem_down = document.createElement('i');
            parte_header_btns_ordem_down.classList.add('fa-solid', 'fa-chevron-down');
            parte_header_btns_ordem_down.addEventListener('click', descerOrdemItem);

            parte_header_btns_ordem.appendChild(parte_header_btns_ordem_up);
            parte_header_btns_ordem.appendChild(parte_header_btns_ordem_down);

            var parte_header_i = document.createElement('i');
            parte_header_i.classList.add('fa-solid', 'fa-trash');
            parte_header_i.addEventListener('click', remParte);

            parte_header.appendChild(parte_header_p);
            parte_header.appendChild(parte_header_btns_ordem);
            parte_header.appendChild(parte_header_i);

            var parte_body = document.createElement('div');
            parte_body.classList.add('parte-body');

            var pt_body_main = document.createElement('div');
            pt_body_main.classList.add('pt-body-main');

            var pbm_infos = document.createElement('div');
            pbm_infos.classList.add('pbm-infos');

            var pt_titulo = document.createElement('div');
            pt_titulo.classList.add('input-group');

            var pt_titulo_label = document.createElement('label');
            pt_titulo_label.setAttribute('for', `pt-titulo-${parte_local_id}`);
            pt_titulo_label.innerText = 'Título';

            var pt_titulo_input = document.createElement('input');
            pt_titulo_input.setAttribute('type', 'text');
            pt_titulo_input.setAttribute('id', `pt-titulo-${parte_local_id}`);
            pt_titulo_input.classList.add('pt-titulo');

            pt_titulo.appendChild(pt_titulo_label);
            pt_titulo.appendChild(pt_titulo_input);

            var div_pt_exclusivo = document.createElement('div');
            div_pt_exclusivo.classList.add('div-pt-exclusivo');

            var pt_exclusivo_label = document.createElement('label');
            pt_exclusivo_label.innerText = 'Exclusivo?';

            var pt_exclusivo_input = document.createElement('input');
            pt_exclusivo_input.setAttribute('type', 'checkbox');
            pt_exclusivo_input.setAttribute('id', `pt-exclusivo-${parte_local_id}`);
            pt_exclusivo_input.classList.add('pt-exclusivo');

            div_pt_exclusivo.appendChild(pt_exclusivo_label);
            div_pt_exclusivo.appendChild(pt_exclusivo_input);

            pbm_infos.appendChild(pt_titulo);
            pbm_infos.appendChild(div_pt_exclusivo);

            var parte_imagem_upload = document.createElement('div');
            parte_imagem_upload.classList.add('parte-imagem-upload');

            var pt_imagem_input = document.createElement('input');
            pt_imagem_input.setAttribute('type', 'file');
            pt_imagem_input.accept = 'image/*, video/*';
            pt_imagem_input.multiple = true;
            pt_imagem_input.setAttribute('id', `pt-imagem-${parte_local_id}`);
            pt_imagem_input.classList.add('pt-imagem');
            pt_imagem_input.style.display = 'none';
            pt_imagem_input.addEventListener('change', previewImageParte);

            var pt_preview_imagem = document.createElement('img');
            pt_preview_imagem.setAttribute('id', `pt-preview-imagem-${parte_local_id}`);
            pt_preview_imagem.classList.add('pt-preview-imagem');
            pt_preview_imagem.setAttribute('src', '');
            pt_preview_imagem.style.opacity = 0;
            pt_preview_imagem.addEventListener('click', function() {
                document.getElementById(`pt-imagem-${parte_local_id}`).click();
            });

            var pt_btn_remover_imagem = document.createElement('div');
            pt_btn_remover_imagem.setAttribute('id', `pt-btn-remover-imagem-${parte_local_id}`);
            pt_btn_remover_imagem.classList.add('pt-btn-remover-imagem');
            pt_btn_remover_imagem.style.display = 'none';
            pt_btn_remover_imagem.addEventListener('click', remover_imagem_parte);

            var pt_btn_remover_imagem_p = document.createElement('p');
            pt_btn_remover_imagem_p.innerText = 'Remover';

            pt_btn_remover_imagem.appendChild(pt_btn_remover_imagem_p);

            parte_imagem_upload.appendChild(pt_imagem_input);
            parte_imagem_upload.appendChild(pt_preview_imagem);
            parte_imagem_upload.appendChild(pt_btn_remover_imagem);

            pt_body_main.appendChild(pbm_infos);
            pt_body_main.appendChild(parte_imagem_upload);

            var pt_descricao = document.createElement('div');
            pt_descricao.classList.add('input-group');

            var pt_descricao_label = document.createElement('label');
            pt_descricao_label.setAttribute('for', `pt-descricao-${parte_local_id}`);
            pt_descricao_label.innerText = 'Descrição';

            var pt_descricao_textarea = document.createElement('textarea');
            pt_descricao_textarea.setAttribute('id', `pt-descricao-${parte_local_id}`);

            pt_descricao.appendChild(pt_descricao_label);
            pt_descricao.appendChild(pt_descricao_textarea);

            parte_body.appendChild(pt_body_main);
            parte_body.appendChild(pt_descricao);

            parte_div.appendChild(parte_header);
            parte_div.appendChild(parte_body);

            partes_body.appendChild(parte_div);

            // Adjust textarea height
            pt_descricao_textarea.style.height = "auto";
            pt_descricao_textarea.style.height = (pt_descricao_textarea.scrollHeight) + "px";
            pt_descricao_textarea.addEventListener("input", function() {
                const scrollPosition = window.scrollY;
                this.style.height = "auto";
                this.style.height = (this.scrollHeight) + "px";
                window.scrollTo(0, scrollPosition);
            });

            // Hide the up button for the first item
            document.querySelectorAll('.parte-btns-ordem .fa-chevron-up').forEach((btn, index) => {
                btn.style.display = index === 0 ? 'none' : 'flex';
            });

            // Hide the down button for the last item
            document.querySelectorAll('.parte-btns-ordem .fa-chevron-down').forEach((btn, index) => {
                btn.style.display = index === partes.length - 1 ? 'none' : 'flex';
            });
        }

        function remParte (event) {
            var parte = event.target.parentElement.parentElement;
            parte.remove();

            var partes = document.getElementsByClassName('parte');
            for (var i = 0; i < partes.length; i++) {
                var parte_header_p = partes[i].querySelector('.parte-header p');
                parte_header_p.innerText = `${i + 1}° Parte`;
            }

            // Hide the up button for the first item
            document.querySelectorAll('.parte-btns-ordem .fa-chevron-up').forEach((btn, index) => {
                btn.style.display = index === 0 ? 'none' : 'flex';
            });

            // Hide the down button for the last item
            document.querySelectorAll('.parte-btns-ordem .fa-chevron-down').forEach((btn, index) => {
                btn.style.display = index === partes.length - 1 ? 'none' : 'flex';
            });
        }

        function subirOrdemItem (event) {
            var parte = event.target.parentElement.parentElement.parentElement;
            //var parte_local_id = parte.getAttribute('parte-local-id');
            var partes = document.getElementsByClassName('parte');

            var posicao_parte = Array.from(partes).indexOf(parte);

            if (posicao_parte > 0) {
                var parte_anterior = partes[posicao_parte - 1];
                //parte_anterior.setAttribute('parte-local-id', parte_local_id);
                //parte.setAttribute('parte-local-id', parte_local_id - 1);

                //parte_anterior.querySelector('.parte-header p').innerText = `${parte_local_id}° Parte`;
                //parte.querySelector('.parte-header p').innerText = `${parte_local_id + 1}° Parte`;

                parte_anterior.parentElement.insertBefore(parte, parte_anterior);
            }

            // Hide the up button for the first item
            document.querySelectorAll('.parte-btns-ordem .fa-chevron-up').forEach((btn, index) => {
                btn.style.display = index === 0 ? 'none' : 'flex';
            });

            // Hide the down button for the last item
            document.querySelectorAll('.parte-btns-ordem .fa-chevron-down').forEach((btn, index) => {
                btn.style.display = index === partes.length - 1 ? 'none' : 'flex';
            });

            var partes = document.getElementsByClassName('parte');
            for (var i = 0; i < partes.length; i++) {
                var parte_header_p = partes[i].querySelector('.parte-header p');
                parte_header_p.innerText = `${i + 1}° Parte`;
            }
        }

        function descerOrdemItem (event) {
            var parte = event.target.parentElement.parentElement.parentElement;
            //var parte_local_id = parte.getAttribute('parte-local-id');
            var partes = document.getElementsByClassName('parte');

            var posicao_parte = Array.from(partes).indexOf(parte);

            if (posicao_parte < partes.length - 1) {
                var parte_proxima = partes[parseInt(posicao_parte) + 1];
                /*parte_proxima.setAttribute('parte-local-id', parte_local_id);
                parte.setAttribute('parte-local-id', parseInt(parte_local_id) + 1);

                parte_proxima.querySelector('.parte-header p').innerText = `${parseInt(parte_local_id) + 1}° Parte`;
                parte.querySelector('.parte-header p').innerText = `${parseInt(parte_local_id) + 2}° Parte`;*/

                parte_proxima.parentElement.insertBefore(parte_proxima, parte);
            }

            // Hide the up button for the first item
            document.querySelectorAll('.parte-btns-ordem .fa-chevron-up').forEach((btn, index) => {
                btn.style.display = index === 0 ? 'none' : 'flex';
            });

            // Hide the down button for the last item
            document.querySelectorAll('.parte-btns-ordem .fa-chevron-down').forEach((btn, index) => {
                btn.style.display = index === partes.length - 1 ? 'none' : 'flex';
            });

            var partes = document.getElementsByClassName('parte');
            for (var i = 0; i < partes.length; i++) {
                var parte_header_p = partes[i].querySelector('.parte-header p');
                parte_header_p.innerText = `${i + 1}° Parte`;
            }
        }

        document.querySelectorAll("textarea").forEach(textarea => {
            textarea.addEventListener("input", function() {
                const scrollPosition = window.scrollY;
                this.style.height = "auto";
                this.style.height = (this.scrollHeight) + "px";
                window.scrollTo(0, scrollPosition);
            });
        });

        function convertToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
        }

        async function listar_imagens_alteradas() {
            var imagens_json = [];

            if (tipo_editor === 'editar') {

                if (item.capa !== '' && item.capa !== null) {
                    imagens_json.push(item.capa);
                }

                item.partes.forEach((parte, index) => {
                    if (!imagens_json.includes(parte.imagem) && parte.imagem !== '') {
                        imagens_json.push(parte.imagem);
                    }
                });

                try {
                    const response = await fetch(`https://api.github.com/repos/YuriGomes4/Nuri/contents/assets/conteudo/${tipo}/${item_id}/fotos`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            //'Authorization': `Bearer ${getCookie('gk')}`
                        }
                    });
                    if (!response.ok) {
                        console.error('Erro ao listar imagens:', response);
                        //return [];
                    } else {
                        const response_json = await response.json();
                        response_json.forEach(imagem => {
                            if (!imagens_json.includes(imagem.name) && imagem.type === "file") {
                                imagens_json.push(imagem.name);
                            }
                        });
                    }
                } catch (error) {
                    console.error('Erro ao listar imagens:', error);
                    //return [];
                }
            }

            var imagens_atuais = [];

            var imagem_capa = document.getElementById('preview-capa');

            if (imagem_capa.src !== '#' && imagem_capa.src !== '' && imagem_capa.src !== window.location.href) {
                if (imagem_capa.src.includes(";base64,")) {
                    if (!imagens_atuais.includes(imagem_capa.getAttribute('file-name'))) {
                        imagens_atuais.push(imagem_capa.getAttribute('file-name'));
                    }
                } else if (imagem_capa.src.includes("imgur")) {
                    if (!imagens_atuais.includes(imagem_capa.src)) {
                        imagens_atuais.push(imagem_capa.src);
                    }
                } else if (imagem_capa.src.includes("/")) {
                    if (!imagens_atuais.includes(imagem_capa.src.split('/').pop())) {
                        imagens_atuais.push(imagem_capa.src.split('/').pop());
                    }
                }
            }

            var partes = document.getElementsByClassName('parte');

            for (let parte of partes) {
                const parte_id = parte.getAttribute('parte-local-id');
                const imagem_parte = document.getElementById(`pt-preview-imagem-${parte_id}`);

                if (imagem_parte.src !== '#' && imagem_parte.src !== '' && imagem_parte.src !== window.location.href) {
                    if (imagem_parte.src.includes(";base64,")) {
                        if (!imagens_atuais.includes(imagem_parte.getAttribute('file-name'))) {
                            imagens_atuais.push(imagem_parte.getAttribute('file-name'));
                        }
                    } else if (imagem_parte.src.includes("imgur")) {
                        if (!imagens_atuais.includes(imagem_parte.src)) {
                            imagens_atuais.push(imagem_parte.src);
                        }
                    } else if (imagem_parte.src.includes("/")) {
                        if (!imagens_atuais.includes(imagem_parte.src.split('/').pop())) {
                            imagens_atuais.push(imagem_parte.src.split('/').pop());
                        }
                    }
                }
            }

            console.log('Imagens atuais:', imagens_atuais);
            console.log('Imagens JSON:', imagens_json);

            var imagens_excluir = [];
            var imagens_adicionar = [];
            imagens_excluir = imagens_json.filter(imagem => !imagens_atuais.includes(imagem));
            imagens_adicionar = imagens_atuais.filter(imagem => !imagens_json.includes(imagem));

            return { imagens_excluir, imagens_adicionar };
        }

        function remover_item() {
            if (confirm('Tem certeza que deseja remover este item?')) {
                fetch(`https://api.github.com/repos/YuriGomes4/Nuri/contents/assets/conteudo/${tipo}/${item_id}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getCookie('gk').split('$sep$')[0]}`
                    }
                })
                    .then(response => response.json())
                    .then(response_json => {
                        const files = response_json.map(file => {
                            return { path: file.path, sha: file.sha, content: null, encoding: 'utf-8' };
                        });

                        var conteudos = JSON.parse(sessionStorage.getItem(tipo));
                        var novo_conteudos = conteudos;
                        delete novo_conteudos[item_id];

                        files.push({ path: `assets/conteudo/${tipo}.json`, content: JSON.stringify(novo_conteudos, null, 4), encoding: 'utf-8' });

                        createCommit('YuriGomes4', 'Nuri', 'Removendo item', files).then(() => {
                            sessionStorage.setItem(tipo, JSON.stringify(novo_conteudos));
                            alert('Item removido com sucesso!');
                            page_out("/max/home.html?opt=noload");
                        }).catch(error => {
                            console.error('Erro ao remover item:', error);
                            alert('Erro ao remover item.');
                        });
                    });
            }
        }

        function salvar() {

            var btn_salvar = document.getElementById('btn-salvar');
            var icone_salvar = btn_salvar.querySelector('i');

            btn_salvar.onclick = null;
            icone_salvar.className = 'loader';

            var imagem_capa = document.getElementById('preview-capa');
            var imagem_capa_src = '';
            if (imagem_capa.src !== '#' && imagem_capa.src !== '' && imagem_capa.src !== window.location.href) {
                if (imagem_capa.src.includes(";base64,")) {
                    imagem_capa_src = imagem_capa.getAttribute('file-name');
                } else if (imagem_capa.src.includes("imgur")) {
                    imagem_capa_src = imagem_capa.src;
                } else if (imagem_capa.src.includes("/")) {
                    imagem_capa_src = imagem_capa.src.split('/').pop();
                }
            }

            const novo_item = {
            nome: document.getElementById('titulo').value,
            sinopse: document.getElementById('sinopse').value,
            autor: document.getElementById('autor').value,
            participantes: Array.from(document.querySelectorAll('.participante p')).map(participante => participante.innerText),
            data: document.getElementById('data').value,
            exclusivo: document.getElementById('exclusivo').checked,
            capa: imagem_capa_src,
            partes: []
            };

            if (novo_item.nome === '' || novo_item.data === '') {
                alert('Preencha todos os campos obrigatórios.');
                return;
            }

            const partes = document.getElementsByClassName('parte');
            for (let parte of partes) {
                const parte_id = parte.getAttribute('parte-local-id');

                var imagem_parte = document.getElementById(`pt-preview-imagem-${parte_id}`);
                var imagem_parte_src = '';
                if (imagem_parte.src !== '#' && imagem_parte.src !== '' && imagem_parte.src !== window.location.href) {
                    if (imagem_parte.src.includes(";base64,")) {
                        imagem_parte_src = imagem_parte.getAttribute('file-name');
                    } else if (imagem_parte.src.includes("imgur")) {
                        imagem_parte_src = imagem_parte.src;
                    } else if (imagem_parte.src.includes("/")) {
                        imagem_parte_src = imagem_parte.src.split('/').pop();
                    }
                }

                var nome_parte = document.getElementById(`pt-titulo-${parte_id}`).value;
                var descricao_parte = document.getElementById(`pt-descricao-${parte_id}`).value;

                if (nome_parte !== '' || descricao_parte !== '' || imagem_parte_src !== '') {
                    novo_item.partes.push({
                        nome: document.getElementById(`pt-titulo-${parte_id}`).value,
                        exclusivo: document.getElementById(`pt-exclusivo-${parte_id}`).checked,
                        imagem: imagem_parte_src,
                        descricao: document.getElementById(`pt-descricao-${parte_id}`).value
                    });
                }

            }

            if (novo_item.partes.length === 0) {
                alert('Preencha pelo menos uma parte.');
                return;
            }

            listar_imagens_alteradas().then(async imagens => {

                console.log('Imagens:', imagens);

                var files = [];

                if (imagens.imagens_excluir) {
                    for (let imagem of imagens.imagens_excluir) {
                        //files.push({ path: `assets/conteudo/${tipo}/${item_id}/fotos/${imagem}`, content: null, encoding: 'utf-8' });

                        if (imagem.includes('imgur')) {
                            const imgur = new ImgurAPI(getCookie('iurl'));

                            await imgur.removeImage(imagem.split('/').pop().split('.')[0]).then(response => {
                                console.log('Imagem excluída:', response);
                            }).catch(error => {
                                console.error('Erro ao excluir imagem:', error);
                                alert('Erro ao excluir imagem.', error);
                            });
                        } else {
                            files.push({ path: `assets/conteudo/${tipo}/${item_id}/fotos/${imagem}`, content: null, encoding: 'utf-8' });
                        }
                    }
                }

                if (imagens.imagens_adicionar) {
                    for (let imagem of imagens.imagens_adicionar) {
                        //files.push({ path: `assets/conteudo/${tipo}/${item_id}/fotos/${imagem}`, content: dict_imagens[imagem], encoding: 'base64' });
                        const imgur = new ImgurAPI(getCookie('iurl'));

                        console.log('Base64:', dict_imagens[imagem]);

                        await imgur.uploadImage(dict_imagens[imagem], 'file', imagem.split('.')[0], "Imagem").then(response => {
                            console.log('Imagem adicionada:', response);
                            if (imagens_local[imagem] === 'capa') {
                                novo_item.capa = response.link;
                            } else {
                                novo_item.partes.forEach(parte => {
                                    if (parte.imagem === imagem) {
                                        parte.imagem = response.link;
                                    }
                                });
                            }
                        }).catch(error => {
                            novo_item.partes.forEach(parte => {
                                if (parte.imagem === imagem) {
                                    parte.imagem = '';
                                }
                            });
                            console.error('Erro ao adicionar imagem:', error);
                            alert('Erro ao adicionar imagem. - ' + error);
                        });

                    }
                }

                console.log('Novo item:', novo_item);

                var conteudos = JSON.parse(sessionStorage.getItem(tipo));
                var novo_conteudos = conteudos;
                novo_conteudos[item_id] = novo_item;

                console.log('Novos conteúdos:', novo_conteudos[item_id]);

                files.push({ path: `assets/conteudo/${tipo}/${item_id}/main.json`, content: JSON.stringify(novo_item), encoding: 'utf-8' });
                files.push({ path: `assets/conteudo/${tipo}.json`, content: JSON.stringify(novo_conteudos), encoding: 'utf-8' });

                console.log('Files:', files);

                createCommit('YuriGomes4', 'Nuri', 'Atualizando item', files).then(() => {
                    sessionStorage.setItem(tipo, JSON.stringify(novo_conteudos));
                    alert('Item atualizado com sucesso!');
                    if (tipo_editor === 'editar') {
                        page_out("back");
                    } else {
                        page_out("/max/item.html?tipo=" + tipo + "&id=" + item_id);
                    }
                }).catch(error => {
                    console.error('Erro ao atualizar item:', error);
                    alert('Erro ao atualizar item.');
                });
            });

            //É só mandar o content como null para remover o arquivo, falta criar pasta e conseguir enviar imagem (precisa converter elas para base64)

            /*function toDataURL(url, callback) {
                var xhr = new XMLHttpRequest();
                xhr.onload = function() {
                    var reader = new FileReader();
                    reader.onloadend = function() {
                        callback(reader.result);
                    }
                    reader.readAsDataURL(xhr.response);
                };
                xhr.open('GET', url);
                xhr.responseType = 'blob';
                xhr.send();
            }

            var img_bs64 = '';

            toDataURL(`/assets/conteudo/${tipo}/${item_id}/fotos/foto4.jpg`, function(dataUrl) {
                img_bs64 = dataUrl;
                console.log(img_bs64);

                const files = [
                    { path: `assets/conteudo/${tipo}/${item_id}/main.json`, content: JSON.stringify(novo_item), encoding: 'utf-8' },
                    { path: `assets/conteudo/${tipo}/${item_id}/fotos/foto5.jpg`, content: img_bs64.split(',')[1], encoding: 'base64' }
                ];

                createCommit('YuriGomes4', 'Nuri', 'Atualizando item', files);
            });*/
        }

        async function createCommit(owner, repo, message, files) {
            const token = getCookie('gk').split('$sep$')[0];

            const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/refs/heads/main`, {
                method: 'GET',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            if (!response.ok) throw new Error('Failed to fetch reference');
            const refData = await response.json();
            const baseTreeSha = refData.object.sha;

            const createBlob = async (content, encoding) => {
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/blobs`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: content,
                        encoding: encoding
                    })
                });
                if (!response.ok) throw new Error('Failed to create blob');
                const data = await response.json();
                return data.sha;
            };

            const treeEntries = await Promise.all(files.map(async file => {
                if (file.content === null) {
                    return {
                        path: file.path,
                        mode: '100644',
                        type: 'blob',
                        sha: null
                    };
                } else {
                    const blobSha = await createBlob(file.content, file.encoding);
                    return {
                        path: file.path,
                        mode: '100644',
                        type: 'blob',
                        sha: blobSha
                    };
                }
            }));

            const createTree = async (baseTreeSha, treeEntries) => {
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/trees`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        base_tree: baseTreeSha,
                        tree: treeEntries
                    })
                });
                if (!response.ok) throw new Error('Failed to create tree');
                const data = await response.json();
                return data.sha;
            };

            const treeSha = await createTree(baseTreeSha, treeEntries);

            const createCommit = async (treeSha) => {
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/commits`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        tree: treeSha,
                        parents: [baseTreeSha]
                    })
                });
                if (!response.ok) throw new Error('Failed to create commit');
                const data = await response.json();
                return data.sha;
            };

            const commitSha = await createCommit(treeSha);

            const updateBranch = async (commitSha) => {
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/refs/heads/main`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sha: commitSha
                    })
                });
                if (!response.ok) throw new Error('Failed to update branch');
            };

            await updateBranch(commitSha);
        }
        
        ////////////////////////////////////////////////////////////////////////////////////

        function page_out (link) {
            var blackout = document.getElementById('blackout');
            var main = document.getElementById('main');

            blackout.style.transition = 'opacity 0.5s ease';
            blackout.offsetHeight;
            blackout.style.opacity = 1;

            main.style.filter = 'blur(100px)';

            setTimeout(() => {
                if (link === 'back') {
                    window.history.back();
                } else {
                    window.location.href = link;
                }
                page_in();
            }, 500);

        }

        function page_in () {
            var blackout = document.getElementById('blackout');
            var main = document.getElementById('main');

            //blackout.style.transition = 'none';
            blackout.style.opacity = 1;
            blackout.offsetHeight;
            blackout.style.transition = 'opacity 0.5s ease';
            blackout.style.opacity = 0;

            main.style.filter = 'blur(0px)';
        }

        function verify_token () {
            const token = getCookie('gk').split('$sep$')[0];
            if (!token) {
                alert("Token não encontrado. Você será redirecionado.");
                page_out("back");
            } else {
                fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Token inválido');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Usuário autenticado:', data);

                    var formData = new FormData();
                    formData.append('refresh_token', getCookie('gk').split('$sep$')[1]);
                    formData.append('client_id', getCookie('gk').split('$sep$')[2]);
                    formData.append('client_secret', getCookie('gk').split('$sep$')[3]);
                    formData.append('grant_type', 'refresh_token');

                    fetch('https://api.imgur.com/oauth2/token', {
                        /*headers: {
                            'Content-Type': 'multipart/form-data'
                        },*/
                        method: 'POST',
                        body: formData,
                        redirect: 'follow'
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Erro ao atualizar token do Imgur');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Token do Imgur atualizado:');
                        setCookie('iurl', data.access_token);

                        onDOMLoaded();
                    })
                })
                .catch(error => {
                    alert("Token inválido. Você será redirecionado.");
                    page_out("back");
                });
            }
        }

        var controle = 0;

        window.onload = function() {
            /*if (senha !== "sua_senha_aqui") {
                alert("Senha incorreta. Você será redirecionado.");
                window.location.href = "/";
            }*/

            const token = getCookie('gk').split('$sep$')[0];
            if (!token) {
                var senha = prompt("Digite a senha de alteração:");
                setCookie('gk', senha);
                verify_token();
            } else {
                fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Token inválido');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Usuário autenticado:', data);

                    var formData = new FormData();
                    formData.append('refresh_token', getCookie('gk').split('$sep$')[1]);
                    formData.append('client_id', getCookie('gk').split('$sep$')[2]);
                    formData.append('client_secret', getCookie('gk').split('$sep$')[3]);
                    formData.append('grant_type', 'refresh_token');

                    fetch('https://api.imgur.com/oauth2/token', {
                        /*headers: {
                            'Content-Type': 'multipart/form-data'
                        },*/
                        method: 'POST',
                        body: formData,
                        redirect: 'follow'
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Erro ao atualizar token do Imgur');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Token do Imgur atualizado:');
                        setCookie('iurl', data.access_token);

                        onDOMLoaded();
                    })
                    .catch(error => {
                        var senha = prompt("Digite a senha de alteração:");
                        setCookie('gk', senha);
                        verify_token();
                    });
                })
                .catch(error => {
                    var senha = prompt("Digite a senha de alteração:");
                    setCookie('gk', senha);
                    verify_token();
                });
            }
        };

        if (document.readyState === "loading")
            document.addEventListener("DOMContentLoaded", onDOMLoaded);
        else 
            onDOMLoaded();

        function onDOMLoaded() {
            controle++;

            if (controle === 2) {
                page_in();
            }
        }
    </script>
</body>
</html>