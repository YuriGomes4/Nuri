<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>Nossa história</title>

    <link rel="manifest" href="/assets/pwa/manifest.json">
	  
	<!--<link rel="icon" type="image/x-icon" href="/assets/images/favicon.ico">-->

	<link href='https://fonts.googleapis.com/css?family=Reenie+Beanie|Shantell+Sans|Kavoon' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="/assets/fontawesome/css/all.css">
    
    <link href="/assets/css/max/global.css" rel="stylesheet" type="text/css" />
    <link href="/assets/css/max/item.css" rel="stylesheet" type="text/css" />
</head>

<body>

    <div id="blackout"></div>

    <div id="fundo"></div>

    <div id="main">
        <div id="header-menu">
            <div id="header-menu-logo">
                <i class="fa-solid fa-arrow-left" onclick="page_out('back')"></i>
            </div>
            <div id="header-menu-buttons">
                <i class="fa-solid fa-magnifying-glass"></i>
                <i class="fa-solid fa-circle-user"></i>
            </div>
        </div>
        <div id="conteudo">
            <div id="banner">
                <img src="" alt="Banner" id="img-principal">
                <div id="banner-blur">
                    <img src="" alt="Banner" id="img-secundaria">
                </div>
            </div>
            <div id="item-info">
                <p id="titulo"></p>
                <div id="item-carac">
                    <p id="item-data"></p>
                    <p id="item-qnt-partes"></p>
                </div>
                <div id="item-buttons">
                    <div id="btn-verhistoria" onclick="page_out(`/max/apresentacao/stories.html?tipo=${tipo}&id=${item_id}`)">
                        <i class="fa-solid fa-book-open-reader"></i>
                        <p>Ver história do início</p>
                    </div>
                    <div id="btn-editarhistoria" onclick="page_out(`/max/editar_item.html?tipo=${tipo}&id=${item_id}`)">
                        <i class="fa-solid fa-pen-to-square"></i>
                        <p>Editar história</p>
                    </div>
                </div>
                <p id="item-sinopse"></p>
                <div id="envolvidos">
                    <p id="m-autor"><span class="mostrador">Quem escreveu: </span><span id="autor"></span></p>
                    <p id="m-participantes"><span class="mostrador">Quem participa: </span><span id="participantes"></span></p>
                </div>
                <div id="separador"></div>
                <div id="item-partes">
                    <p>Partes</p>
                    <div id="partes-lista"></div>
                </div>
            </div>
        </div>
    </div>

    <script>

        const urlParams = new URLSearchParams(window.location.search);
        const tipo = urlParams.get('tipo');
        const id = urlParams.get('id');
        const item_id = id;

        var texto_btnverhistoria = document.getElementById('btn-verhistoria').querySelector('p');
        if (tipo === 'historia') {
            texto_btnverhistoria.textContent = 'Ver recordação do início';
        } else if (tipo === 'especial') {
            texto_btnverhistoria.textContent = 'Ver história do início';
        } else {
            console.log('Tipo inválido.');
        }

        function setCookie(name, value) {
			document.cookie = name + "=" + value;
		}

        function getCookie(name) {
			const cookieValue = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
			return cookieValue ? cookieValue.pop() : '';
		}

        /*var api_headers = {};

        async function verify_token_header() {
            if (!document.cookie.split('; ').find(row => row.startsWith('gk='))) {
            setCookie("gk", "");
            } else {
            try {
                const response = await fetch(`https://api.github.com/user`, {
                headers: {
                    Authorization: `token ${getCookie("gk")}`
                }
                });

                if (response.ok) {
                console.log('Usuário autenticado:', response);
                const token = getCookie("gk");
                api_headers = {
                    Authorization: `Bearer ${token}`
                };
                } else {
                console.error('Erro ao autenticar usuário:', response.statusText);
                }
            } catch (error) {
                console.error('Erro ao autenticar usuário:', error);
            }
            }
        }

        (async () => {
            await verify_token_header();
        })();*/

        if (tipo && id) {
            console.log(`Tipo: ${tipo}, ID: ${id}`);
            //fetch(`https://api.github.com/repos/YuriGomes4/Nuri/contents/assets/conteudo/${tipo}/${id}/main.json?timestamp=${new Date().getTime()}`, {headers: api_headers})
            fetch(`https://raw.githubusercontent.com/YuriGomes4/Nuri/main/assets/conteudo/${tipo}/${id}/main.json?timestamp=${new Date().getTime()}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .catch(error => {
                    console.error('There has been a problem with your fetch operation:', error);
                })
                .then(item_json => {
                    //main_json = JSON.parse(decodeURIComponent(escape(atob(item_json.content))));
                    main_json = item_json;

                    console.log(main_json);
                    var imagem_capa = `https://raw.githubusercontent.com/YuriGomes4/Nuri/main/assets/conteudo/${tipo}/${id}/fotos/` + main_json.capa;
                    if (tipo === 'historia') {
                        document.getElementById('img-principal').src = imagem_capa;
                        document.getElementById('img-secundaria').src = imagem_capa;
                    } else if (tipo === 'especial') {
                        document.getElementById('img-principal').src = imagem_capa;
                        document.getElementById('img-secundaria').src = imagem_capa;
                    } else {
                        console.log('Tipo inválido.');
                    }

                    document.getElementById('titulo').innerText = main_json.nome;
                    const data = main_json.data.split('-').reverse().join('/');
                    document.getElementById('item-data').innerText = data;
                    document.getElementById('item-qnt-partes').innerText = main_json.partes.length + ' partes';
                    document.getElementById('item-sinopse').innerText = main_json.sinopse;

                    var envolvidos = document.getElementById('envolvidos');

                    if (main_json.autor || main_json.participantes) {
                        envolvidos.style.display = 'flex';

                        var m_autor = document.getElementById('m-autor');
                        var m_participantes = document.getElementById('m-participantes');
                        var autor = document.getElementById('autor');
                        var participantes = document.getElementById('participantes');

                        var mostrador_participantes = m_participantes.querySelector('.mostrador');
                        console.log(mostrador_participantes);
                        if (tipo === 'historia') {
                            mostrador_participantes.textContent = 'Quem está na recordação: ';
                        } else if (tipo === 'especial') {
                            mostrador_participantes.textContent = 'Quem está na história: ';
                        }

                        if (main_json.autor) {
                            m_autor.style.display = 'block';
                            autor.innerText = main_json.autor;
                        } else {
                            m_autor.style.display = 'none';
                        }

                        if (main_json.participantes) {
                            if (main_json.participantes.length > 0) {
                                m_participantes.style.display = 'block';
                                participantes.innerText = main_json.participantes.join(', ');
                            } else {
                                m_participantes.style.display = 'none';
                            }
                        } else {
                            m_participantes.style.display = 'none';
                        }
                    } else {
                        envolvidos.style.display = 'none';
                    }

                    var partes_lista = document.getElementById('partes-lista');

                    main_json.partes.forEach((parte, index) => {
                        var div = document.createElement('div');
                        div.className = 'parte-item';
                        div.onclick = function() {
                            page_out(`/max/apresentacao/stories.html?tipo=${tipo}&id=${id}&parte=${index}`);
                        };

                        //var imagem_parte = `https://api.github.com/repos/YuriGomes4/Nuri/contents/assets/conteudo/${tipo}/${id}/fotos/` + parte.imagem;
                        var imagem_parte = `https://raw.githubusercontent.com/YuriGomes4/Nuri/main/assets/conteudo/${tipo}/${id}/fotos/` + parte.imagem;

                        if (parte.imagem.includes('.mp4')) {
                            var video = document.createElement('video');
                            video.src = imagem_parte;
                            video.autoplay = false;
                            video.controls = false;
                            video.muted = false;
                            video.loop = false;

                            div.appendChild(video);
                        } else {
                            var img = document.createElement('img');
                            img.src = imagem_parte;

                            div.appendChild(img);
                        }

                        var p = document.createElement('p');
                        p.textContent = index + 1 + '. ' + parte.nome;

                        div.appendChild(p);

                        var icon = document.createElement('i');
                        icon.className = 'fa-solid fa-chevron-right';

                        div.appendChild(icon);

                        partes_lista.appendChild(div);
                    });
                });
        } else {
            console.log('Parâmetros tipo e id não encontrados.');
        }

        function page_out (link) {
            var blackout = document.getElementById('blackout');
            var main = document.getElementById('main');

            blackout.style.transition = 'opacity 0.5s ease';
            blackout.offsetHeight;
            blackout.style.opacity = 1;

            main.style.filter = 'blur(100px)';

            setTimeout(() => {
                if (link === 'back') {
                    window.history.back();
                } else {
                    window.location.href = link;
                }
                page_in();
            }, 500);

        }

        function page_in () {
            var blackout = document.getElementById('blackout');
            var main = document.getElementById('main');

            //blackout.style.transition = 'none';
            blackout.style.opacity = 1;
            blackout.offsetHeight;
            blackout.style.transition = 'opacity 0.5s ease';
            blackout.style.opacity = 0;

            main.style.filter = 'blur(0px)';
        }



        if (document.readyState === "loading")
            document.addEventListener("DOMContentLoaded", onDOMLoaded);
        else 
            onDOMLoaded();

        function onDOMLoaded() {
            page_in();
        }
    </script>
</body>

</html>